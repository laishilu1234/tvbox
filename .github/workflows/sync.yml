name: Upstream Sync

permissions:
  contents: write
  workflows: write
  actions: write

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:
    inputs:
      upstream_branch:
        description: "‰∏äÊ∏∏‰ªìÂ∫ìÂàÜÊîØ"
        required: true
        default: "main"
        type: string
      target_branch:
        description: "ÁõÆÊ†á‰ªìÂ∫ìÂàÜÊîØ"
        required: true
        default: "main"
        type: string
      sync_strategy:
        description: "ÂêåÊ≠•Á≠ñÁï•"
        required: true
        default: "discard"
        type: choice
        options:
          - discard # Âº∫Âà∂ÂêåÊ≠•Ôºö‰∏¢ÂºÉÊú¨Âú∞‰øÆÊîπÔºåÂÆåÂÖ®Â§çÂà∂‰∏äÊ∏∏ (Êé®Ëçê)
          - merge   # Â∞ùËØïÂêàÂπ∂ÔºöÂ¶ÇÊûúÊúâÂÜ≤Á™Å‰ºöÊä•Èîô

env:
  UPSTREAM_REPO: "cluntop/tvbox"
  UPSTREAM_BRANCH: ${{ github.event.inputs.upstream_branch || 'main' }}
  TARGET_BRANCH: ${{ github.event.inputs.target_branch || 'main' }}
  SYNC_STRATEGY: ${{ github.event.inputs.sync_strategy || 'discard' }}

jobs:
  sync_upstream:
    name: Sync and Notify
    runs-on: ubuntu-latest
    if: ${{ github.event.repository.fork }}

    steps:
      - name: Checkout Target Repo
        uses: actions/checkout@v6
        with:
          ref: ${{ env.TARGET_BRANCH }}
          persist-credentials: true
          fetch-depth: 0

      - name: Sync Upstream Changes
        id: sync
        uses: aormsby/Fork-Sync-With-Upstream-action@v3.4.1
        with:
          upstream_sync_repo: ${{ env.UPSTREAM_REPO }}
          upstream_sync_branch: ${{ env.UPSTREAM_BRANCH }}
          target_sync_branch: ${{ env.TARGET_BRANCH }}
          target_repo_token: ${{ secrets.GITHUB_TOKEN }}
          upstream_pull_args: ${{ env.SYNC_STRATEGY == 'discard' && '--allow-unrelated-histories --force' || '' }}
          target_branch_push_args: ${{ env.SYNC_STRATEGY == 'discard' && '--force' || '' }}
          test_mode: false

      - name: Generate Summary
        run: |
          echo "### üîÑ ÂêåÊ≠•Êä•Âëä (Sync Report)" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          echo "| **Ê∫ê‰ªìÂ∫ì** | [${{ env.UPSTREAM_REPO }}](https://github.com/${{ env.UPSTREAM_REPO }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| **ÁªìÊûú** | ${{ steps.sync.outputs.sync_status == 'success' && '‚úÖ ÊàêÂäü (Success)' || '‚ùå Â§±Ë¥• (Failed)' }} |" >> $GITHUB_STEP_SUMMARY

      - name: Notify Failure via Telegram
        if: failure() && secrets.TELEGRAM_TOKEN != ''
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            üö® **GitHub Actions ÂêåÊ≠•Â§±Ë¥•ÔºÅ**
            
            ‰ªìÂ∫ì: ${{ github.repository }}
            ‰∏äÊ∏∏: ${{ env.UPSTREAM_REPO }}
            
            ËØ∑Ê£ÄÊü•: https://github.com/${{ github.repository }}/actions

      - name: Keepalive Workflow
        uses: gautamkrishnar/keepalive-workflow@v2
        with:
          use_github_bot: true

      - name: Delete Old Workflows
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: 1
          keep_minimum_runs: 3
